---
- name: detect Linux variables
  import_tasks: base/linux_vars.yml
  when: ansible_os_family != "Darwin"

- name: detect Mac OS X variables
  import_tasks: base/osx_vars.yml
  when: ansible_os_family == "Darwin"

- name: assert home directory is detected
  assert: { that: user_home | length > 0 }

- name: assert current shell is detected
  assert: { that: user_shell | length > 0 }

- name: clone oh_my_zsh for {{ user }}
  git:
    repo: "{{ repository }}"
    dest: "{{ user_home }}/.oh_my_zsh"
    version: "{{ version }}"
  become: yes
  become_user: "{{ user }}"

# - name: .bash_profile loads .bashrc for {{ user }}
#   blockinfile:
#     dest: "{{ user_home }}/.bash_profile"
#     create: yes
#     owner: "{{ user }}"
#     block: |
#       if [ -f ~/.bashrc ]; then
#         source ~/.bashrc
#       fi

- name: change shell to bash for {{ user }}
  command: "chsh -s /bin/bash {{ user }}"
  become: yes
  become_user: root
  when: user_shell != "/bin/bash"

- name: install oh_my_zsh on .bashrc for {{ user }}
  lineinfile:
    dest: "{{ user_home }}/.bashrc"
    create: yes
    owner: "{{ user }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - { regexp: '^export oh_my_zsh=', line: 'export oh_my_zsh="$HOME/.oh_my_zsh"' }
    - { regexp: '^export oh_my_zsh_THEME=', line: 'export oh_my_zsh_THEME={{ theme }}' }
    - { regexp: '^source \$oh_my_zsh', line: 'source $oh_my_zsh/oh_my_zsh.sh' }

- name: install oh_my_zsh plugins for {{ user }}
  command: "/bin/bash -i -l -c \"bash-it enable plugin {{ plugins|join(' ') }}\""
  become: yes
  become_user: "{{ user }}"
  when: plugins is defined
  register: plugins_result
  changed_when: "plugins_result.stdout_lines | reject('match', '.* is already enabled.') | list | length > 0"

- name: install oh_my_zsh aliases for {{ user }}
  command: "/bin/bash -i -l -c \"bash-it enable alias {{ aliases|join(' ') }}\""
  become: yes
  become_user: "{{ user }}"
  when: aliases is defined
  register: aliases_result
  changed_when: "aliases_result.stdout_lines | reject('match', '.* is already enabled.') | list | length > 0"

- name: install oh_my_zsh completions for {{ user }}
  command: "/bin/bash -i -l -c \"bash-it enable completion {{ completions|join(' ') }}\""
  become: yes
  become_user: "{{ user }}"
  when: completions is defined
  register: completions_result
  changed_when: "completions_result.stdout_lines | reject('match', '.* is already enabled.') | list | length > 0"
