#!/bin/bash
set -o errexit -o xtrace

REGION=eu-west-1
NAME=cloud9pp
IAMUSER=hprudent


BUCKET=$NAME-$REGION-$IAMUSER

aws s3api head-bucket --bucket "$BUCKET" || aws s3 mb "s3://${BUCKET}"

aws s3 cp cloud9pp.yml "s3://${BUCKET}"
aws s3 cp --recursive templates/ "s3://${BUCKET}/templates"

if [ ! -f .created ];then
  aws --region $REGION cloudformation create-stack --stack-name $NAME --template-body file://cloud9pp.yml --parameters ParameterKey=S3TemplateBucket,ParameterValue=$BUCKET ParameterKey=IAMUser,ParameterValue=$IAMUSER  --tags Key=auto-delete,Value=never --capabilities CAPABILITY_IAM  CAPABILITY_NAMED_IAM
  touch .created
else
  aws --region $REGION cloudformation update-stack --stack-name $NAME --template-body file://cloud9pp.yml --parameters ParameterKey=S3TemplateBucket,ParameterValue=$BUCKET ParameterKey=IAMUser,ParameterValue=$IAMUSER  --tags Key=auto-delete,Value=never --capabilities CAPABILITY_IAM  CAPABILITY_NAMED_IAM
fi

